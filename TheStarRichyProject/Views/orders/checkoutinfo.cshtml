@{
    ViewData["Title"] = "ข้อมูลการจัดส่งและชำระเงิน - Step 2/3";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var cart = ViewBag.Cart as TheStarRichyProject.Models.CartData;
    var branches = ViewBag.Branches as List<TheStarRichyProject.Models.BranchData>;
    var paymentbank = ViewBag.PaymentBank as dynamic;
}

<style>
    /* Step Indicator */
    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        position: relative;
    }

        .step-indicator::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e0e0e0;
            z-index: 0;
        }

    .step {
        flex: 1;
        text-align: center;
        position: relative;
        z-index: 1;
    }

    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e0e0e0;
        margin: 0 auto 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #999;
        box-shadow: 0 0 0 4px #fff;
    }

    .step.active .step-circle {
        background: #405189;
        color: white;
    }

    .step.completed .step-circle {
        background: #198754;
        color: white;
    }

    /* Form Section */
    .form-section {
        background: white;
        padding: 25px;
        border-radius: 12px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .form-section-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #405189;
        color: #405189;
    }

    /* Universal Card Style for Options */
    .payment-card, .delivery-card {
        border: 2px solid #eff2f7;
        border-radius: 12px;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        background: #fff;
    }

        .payment-card:hover, .delivery-card:hover {
            border-color: #405189;
            background-color: #f9f9f9;
        }

        .payment-card:has(input:checked), .delivery-card:has(input:checked) {
            border-color: #405189;
            background-color: #f6f8ff;
            box-shadow: 0 4px 12px rgba(64, 81, 137, 0.08);
        }

    /* Address Card */
    .address-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

        .address-card:hover {
            border-color: #405189;
        }

        .address-card.selected {
            border-color: #405189;
            background: #f6f8ff;
            box-shadow: 0 2px 8px rgba(64, 81, 137, 0.1);
        }

    /* Invoice Card Styles */
    .invoice-card {
        border: 2px solid #eff2f7;
        border-radius: 10px;
        padding: 15px 10px;
        text-align: center;
        transition: all 0.2s ease;
        cursor: pointer;
        background: #fff;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .invoice-card:hover {
            border-color: #405189;
        }

        .invoice-card:has(input:checked) {
            border-color: #405189;
            background-color: #f6f8ff;
            color: #405189;
        }

    .invoice-label {
        cursor: pointer;
        margin-bottom: 0;
        font-weight: 500;
        font-size: 0.85rem;
    }

        .invoice-label i {
            color: #878a99;
            transition: color 0.2s;
        }

    .invoice-card:has(input:checked) i {
        color: #405189;
    }

    /* Order Summary Sticky Box */
    .order-summary-box {
        background: white;
        border-radius: 12px;
        position: sticky;
        top: 90px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    /* Utilities */
    .bg-soft-primary {
        background-color: rgba(64, 81, 137, 0.1) !important;
    }

    .bg-soft-success {
        background-color: rgba(10, 179, 156, 0.1) !important;
    }

    .bg-soft-info {
        background-color: rgba(41, 156, 219, 0.1) !important;
    }

    .bank-info-box {
        background-color: #ffffff !important;
        border: 1px dashed #ced4da !important;
    }

    .cursor-pointer {
        cursor: pointer;
    }
</style>

<div class="container-fluid py-4">
    <div class="row justify-content-center mb-4">
        <div class="col-lg-8">
            <div class="step-indicator">
                <div class="step completed">
                    <div class="step-circle"><i class="fas fa-check"></i></div>
                    <div class="fw-medium">เลือกสินค้า</div>
                </div>
                <div class="step active">
                    <div class="step-circle">2</div>
                    <div class="fw-medium">ข้อมูลการจัดส่ง</div>
                </div>
                <div class="step">
                    <div class="step-circle">3</div>
                    <div class="fw-medium">ชำระเงิน</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-section h-100">
                        <div class="form-section-title">
                            <i class="fas fa-credit-card me-2"></i>วิธีชำระเงิน
                        </div>
                        @if (paymentbank.CheckPaymentGateway == "0")
                        {
                            <div class="payment-card mb-3" onclick="document.getElementById('paymentPromptPay').click()">
                                <div class="d-flex align-items-center p-3">
                                    <div class="form-check custom-radio me-2">
                                        <input type="radio" name="paymentMethod" value="PromptPay" id="paymentPromptPay" class="form-check-input" checked>
                                    </div>
                                    <div class="flex-grow-1">
                                        <label for="paymentPromptPay" class="d-block mb-0 cursor-pointer">
                                            <strong class="d-block">พร้อมเพย์ (QR Code)</strong>
                                            <small class="text-muted">สแกนจ่ายได้ทุกแอปธนาคาร</small>
                                        </label>
                                    </div>
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/c/c5/PromptPay-logo.png" height="20">
                                </div>
                            </div>

                            <div class="payment-card mb-3" onclick="document.getElementById('paymentCard').click()">
                                <div class="d-flex align-items-center p-3">
                                    <div class="form-check custom-radio me-2">
                                        <input type="radio" name="paymentMethod" value="CreditCard" id="paymentCard" class="form-check-input">
                                    </div>
                                    <div class="flex-grow-1">
                                        <label for="paymentCard" class="d-block mb-0 cursor-pointer">
                                            <strong class="d-block">บัตรเครดิต / เดบิต</strong>
                                            <small class="text-muted">Visa, MasterCard, JCB</small>
                                        </label>
                                    </div>
                                    <div>
                                        <i class="ri-visa-fill fs-20 text-primary"></i>
                                        <i class="ri-mastercard-fill fs-20 text-danger"></i>
                                    </div>
                                </div>
                            </div>
                        }

                        <div class="payment-card mb-3" onclick="document.getElementById('paymentBankTransfer').click()">
                            <div class="d-flex align-items-start p-3">
                                <div class="form-check custom-radio me-2 mt-1">
                                    <input type="radio" name="paymentMethod" value="BankTransfer" id="paymentBankTransfer" class="form-check-input">
                                </div>
                                <div class="flex-grow-1">
                                    <label for="paymentBankTransfer" class="d-block mb-0 cursor-pointer">
                                        <div class="d-flex align-items-center mb-1">
                                            <span class="badge bg-primary-subtle text-primary me-2">แนะนำ</span>
                                            <strong class="text-dark">เงินโอน (Bank Transfer)</strong>
                                        </div>
                                        <small class="text-muted d-block mb-2">ตรวจสอบยอดภายใน 5-15 นาทีในขั้นตอนถัดไป</small>

                                        <div class="bank-info-box p-2 rounded bg-light">
                                            <div class="d-flex align-items-center justify-content-between mb-1">
                                                <small class="fw-bold text-uppercase">@paymentbank.BankName</small>
                                                <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-2 fs-11" onclick="copyAccNumber()">คัดลอก</button>
                                            </div>
                                            <div class="h6 mb-0 text-primary fw-bold">@($"เลขที่บัญชี {paymentbank.AccountNumber}")</div>
                                            <small class="text-muted fs-11">@($"ชื่อบัญชี {paymentbank.AccountName}")</small>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-section h-100">
                        <div class="form-section-title">
                            <i class="fas fa-shipping-fast me-2"></i>การจัดส่งสินค้า
                        </div>

                        <div class="delivery-card mb-3" onclick="document.getElementById('deliveryShip').click()">
                            <div class="d-flex align-items-center p-3">
                                <div class="form-check custom-radio me-2">
                                    <input type="radio" name="deliveryMethod" value="Delivery" id="deliveryShip" class="form-check-input" checked>
                                </div>
                                <div class="flex-grow-1">
                                    <label for="deliveryShip" class="d-flex justify-content-between align-items-center mb-0 cursor-pointer">
                                        <div>
                                            <strong class="d-block">ให้จัดส่งตามที่อยู่</strong>
                                            <small class="text-muted">ส่งด่วนถึงบ้าน 1-3 วัน</small>
                                        </div>
                                        <span class="badge bg-soft-primary text-primary">฿ @(cart?.ShippingFee ?? 0)</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="delivery-card mb-3" onclick="document.getElementById('deliveryPickup').click()">
                            <div class="d-flex align-items-center p-3">
                                <div class="form-check custom-radio me-2">
                                    <input type="radio" name="deliveryMethod" value="Pickup" id="deliveryPickup" class="form-check-input">
                                </div>
                                <div class="flex-grow-1">
                                    <label for="deliveryPickup" class="d-flex justify-content-between align-items-center mb-0 cursor-pointer">
                                        <div>
                                            <strong class="d-block">รับเองที่ศูนย์กระจายสินค้า</strong>
                                            <small class="text-muted">รับได้ทันที ไม่มีค่าใช้จ่าย</small>
                                        </div>
                                        <span class="badge bg-soft-success text-success">ฟรี</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-12">
                    <div class="form-section" id="shippingAddressSection">
                        <div class="form-section-title">
                            <i class="fas fa-map-marker-alt me-2"></i>ที่อยู่จัดส่งสินค้า
                        </div>

                        <div class="mb-4">
                            <select class="form-select form-select-lg border-primary-subtle" id="addressTypeSelect">
                                <option value="">-- กรุณาเลือกประเภทที่อยู่จัดส่ง --</option>
                                <option value="MemberAddress">ส่งตามที่อยู่สมาชิก</option>
                                <option value="FavoriteAddress">เลือกจากที่อยู่ที่เคยจัดส่ง</option>
                                <option value="Other">เพิ่มที่อยู่ใหม่</option>
                            </select>
                        </div>

                        <div id="memberAddressesSection" style="display: none;">
                            <div id="memberAddressesList" class="row"></div>
                        </div>

                        <div id="favoriteAddressesSection" style="display: none;">
                            <div id="favoriteAddressesList" class="row"></div>
                        </div>

                        <div id="customAddressForm" style="display: none;" class="bg-light p-3 rounded-3">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label fw-bold">ระบุที่อยู่โดยละเอียด *</label>
                                    <textarea class="form-control" id="addressLine" rows="2" placeholder="บ้านเลขที่, อาคาร, ถนน..."></textarea>
                                </div>
                                <div class="col-md-6 mb-3"><label class="form-label">จังหวัด *</label><input type="text" class="form-control" id="province"></div>
                                <div class="col-md-6 mb-3"><label class="form-label">เขต/อำเภอ *</label><input type="text" class="form-control" id="district"></div>
                                <div class="col-md-6 mb-3"><label class="form-label">แขวง/ตำบล *</label><input type="text" class="form-control" id="subDistrict"></div>
                                <div class="col-md-6 mb-3"><label class="form-label">รหัสไปรษณีย์ *</label><input type="text" class="form-control" id="postalCode" maxlength="5"></div>
                                <div class="col-md-12"><label class="form-label">เบอร์โทรศัพท์ผู้รับ *</label><input type="tel" class="form-control" id="phone"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section" id="branchSection" style="display: none;">
                        <div class="form-section-title"><i class="fas fa-store me-2"></i>สาขาที่ต้องการรับสินค้า</div>
                        <select class="form-select form-select-lg" id="branchSelect">
                            <option value="">-- เลือกสาขาที่ใกล้บ้านคุณ --</option>
                            @if (branches != null)
                            {
                                foreach (var branch in branches)
                                {
                                    <option value="@branch.BranchCode">@branch.BranchName</option>
                                }
                            }
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="order-summary-box shadow-sm border-0">
                <div class="form-section-title p-3 border-bottom mb-0">
                    <div class="fw-bold mb-0">สรุปคำสั่งซื้อ</div>
                </div>
                <div class="p-3">
                    @if (cart != null)
                    {
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">จำนวนสินค้า</span>
                            <span class="fw-bold">@cart.Items.Sum(x => x.Quantity) รายการ</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">ยอดรวมสินค้า</span>
                            <span class="fw-bold">฿@cart.TotalAmount.ToString("N2")</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">คะแนน PV ทั้งหมด</span>
                            <span class="badge bg-soft-info text-info fw-bold">@cart.TotalPV.ToString("N0") PV</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span class="text-muted">ค่าจัดส่ง</span>
                            <span class="fw-bold" id="shippingFeeDisplay">฿@cart.ShippingFee.ToString("N2")</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="h6 fw-bold mb-0">ยอดรวมสุทธิ</span>
                            <span class="h4 fw-bold text-primary mb-0" id="grandTotalDisplay">฿@((cart.TotalAmount + cart.ShippingFee).ToString("N2"))</span>
                        </div>
                    }

                    <button type="button" class="btn btn-primary btn-lg w-100 fw-bold mb-2 shadow" id="btnProceedPayment">
                        ดำเนินการชำระเงิน <i class="ri-arrow-right-line ms-1"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary w-100 btn-md" onclick="window.location.href='/orders/buypersonalorder'">
                        <i class="ri-arrow-left-line me-1"></i> กลับไปแก้ไขสินค้า
                    </button>
                </div>
            </div>

            <div class="form-section mt-4">
                <div class="form-section-title mb-3">
                    <div class="text-primary mb-0"><i class="fas fa-file-invoice me-2"></i>การรับใบเสร็จ</div>
                </div>
                <div class="row g-2">
                    <div class="col-4">
                        <div class="invoice-card" onclick="document.getElementById('sendInvoiceYes').click()">
                            <input class="d-none" type="radio" name="sendInvoice" value="1" id="sendInvoiceYes" checked>
                            <label class="invoice-label" for="sendInvoiceYes">
                                <i class="ri-mail-send-line fs-20 d-block"></i><span>ตามที่อยู่</span>
                            </label>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="invoice-card" onclick="document.getElementById('sendInvoiceNo').click()">
                            <input class="d-none" type="radio" name="sendInvoice" value="0" id="sendInvoiceNo">
                            <label class="invoice-label" for="sendInvoiceNo">
                                <i class="ri-mail-line fs-20 d-block"></i><span>Email</span>
                            </label>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="invoice-card" onclick="document.getElementById('sendInvoiceNo2').click()">
                            <input class="d-none" type="radio" name="sendInvoice" value="2" id="sendInvoiceNo2">
                            <label class="invoice-label" for="sendInvoiceNo2">
                                <i class="ri-close-circle-line fs-20 d-block"></i><span>ไม่รับ</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            let memberAddresses = [];
            let favoriteAddresses = [];
            let selectedMemberAddress = null;
            let selectedFavoriteAddress = null;

            // Delivery Method Logic
            $('.delivery-card').click(function () {
                const method = $(this).find('input').val();
                if (method === 'Delivery') {
                    $('#shippingAddressSection').slideDown();
                    $('#branchSection').slideUp();
                    updateSummary(false);
                } else {
                    $('#shippingAddressSection').slideUp();
                    $('#branchSection').slideDown();
                    updateSummary(true);
                }
            });

            // Address Type Selection
            $('#addressTypeSelect').change(function () {
                const type = $(this).val();
                $('#memberAddressesSection, #favoriteAddressesSection, #customAddressForm').hide();

                if (type === 'MemberAddress') {
                    loadMemberAddresses();
                    $('#memberAddressesSection').fadeIn();
                } else if (type === 'FavoriteAddress') {
                    loadFavoriteAddresses();
                    $('#favoriteAddressesSection').fadeIn();
                } else if (type === 'Other') {
                    $('#customAddressForm').fadeIn();
                }
            });

            function loadMemberAddresses() {
                $.get('/orders/GetAddresses', function(res) {
                    if(res.success) {
                        memberAddresses = res.data;
                        let html = '';
                        res.data.forEach((addr, i) => {
                            html += `
                                <div class="col-md-6 mb-2">
                                    <div class="address-card member-address-card" data-index="${i}">
                                        <div class="fw-bold text-primary fs-13"><i class="fas fa-home me-1"></i> ${addr.addressTypeDisplay}</div>
                                        <small class="d-block text-muted mt-1 text-truncate-2">${addr.fullAddress}</small>
                                        <small class="text-muted">โทร: ${addr.phone}</small>
                                    </div>
                                </div>`;
                        });
                        $('#memberAddressesList').html(html);
                        $('.member-address-card').click(function() {
                            $('.member-address-card').removeClass('selected');
                            $(this).addClass('selected');
                            selectedMemberAddress = memberAddresses[$(this).data('index')];
                        });
                    }
                });
            }

            function loadFavoriteAddresses() {
                $.get('/orders/GetFavoriteAddresses', function(res) {
                    if(res.success) {
                        favoriteAddresses = res.data;
                        let html = '';
                        res.data.forEach((addr, i) => {
                            html += `
                                <div class="col-md-6 mb-2">
                                    <div class="address-card favorite-address-card" data-index="${i}">
                                        <div class="fw-bold text-warning fs-13"><i class="fas fa-star me-1"></i> ${addr.contacNickname || 'ที่อยู่เดิม'}</div>
                                        <small class="d-block text-muted mt-1 text-truncate-2">${addr.contactperson}</small>
                                        <small class="text-muted">โทร: ${addr.contact_Phone}</small>
                                    </div>
                                </div>`;
                        });
                        $('#favoriteAddressesList').html(html);
                        $('.favorite-address-card').click(function() {
                            $('.favorite-address-card').removeClass('selected');
                            $(this).addClass('selected');
                            selectedFavoriteAddress = favoriteAddresses[$(this).data('index')];
                        });
                    }
                });
            }

            function updateSummary(isPickup) {
                const total = @(cart?.TotalAmount ?? 0);
                const fee = isPickup ? 0 : @(cart?.ShippingFee ?? 0);
                const grand = total + fee;
                $('#shippingFeeDisplay').html(isPickup ? '<span class="text-success fw-bold">ฟรี</span>' : '฿' + fee.toLocaleString(undefined, {minimumFractionDigits: 2}));
                $('#grandTotalDisplay').text('฿' + grand.toLocaleString(undefined, {minimumFractionDigits: 2}));
            }

            $('#btnProceedPayment').click(function () {
                const btn = $(this);
                const paymentMethod = $('input[name="paymentMethod"]:checked').val();
                const deliveryMethod = $('input[name="deliveryMethod"]:checked').val();
                const sendInvoice = $('input[name="sendInvoice"]:checked').val();

                if (!paymentMethod || !deliveryMethod) {
                    Swal.fire('แจ้งเตือน', 'กรุณาเลือกวิธีชำระเงินและวิธีจัดส่ง', 'warning');
                    return;
                }

                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> กำลังบันทึก...');

                const request = {
                    paymentMethod: paymentMethod,
                    deliveryMethod: deliveryMethod,
                    sendInvoice: sendInvoice
                };

                if (deliveryMethod === 'Delivery') {
                    const addressType = $('#addressTypeSelect').val();
                    if (!addressType) {
                        Swal.fire('แจ้งเตือน', 'กรุณาเลือกที่อยู่จัดส่ง', 'warning');
                        btn.prop('disabled', false).text('ดำเนินการชำระเงิน');
                        return;
                    }
                    request.deliveryAddressType = addressType;

                    if (addressType === 'MemberAddress' && selectedMemberAddress) {
                        request.memberAddress = selectedMemberAddress;
                    } else if (addressType === 'FavoriteAddress' && selectedFavoriteAddress) {
                        request.favoriteAddress = selectedFavoriteAddress;
                    } else if (addressType === 'Other') {
                        request.customAddress = {
                            addressLine: $('#addressLine').val(),
                            province: $('#province').val(),
                            district: $('#district').val(),
                            subDistrict: $('#subDistrict').val(),
                            postalCode: $('#postalCode').val(),
                            phone: $('#phone').val()
                        };
                    }
                } else {
                    request.branchCode = $('#branchSelect').val();
                    request.deliveryAddressType = "Branch";
                }

                $.ajax({
                    url: '/orders/SaveCheckoutInfo',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(request),
                    success: function (response) {
                        if (response.success) {
                            window.location.href = '/orders/payment?orderID=' + response.orderID;
                        } else {
                            Swal.fire('ผิดพลาด', response.message, 'error');
                            btn.prop('disabled', false).text('ดำเนินการชำระเงิน');
                        }
                    },
                    error: function () {
                        Swal.fire('ผิดพลาด', 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้', 'error');
                        btn.prop('disabled', false).text('ดำเนินการชำระเงิน');
                    }
                });
            });
        });

        function copyAccNumber() {
            var accNo = "@paymentbank.AccountNumber";
            navigator.clipboard.writeText(accNo).then(() => {
                Swal.fire({ title: 'คัดลอกแล้ว', icon: 'success', timer: 1000, showConfirmButton: false });
            });
        }
    </script>
}